<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pilot Validation Dashboard</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/dc.3.0.9.min.css"/>
	<link rel="stylesheet" type="text/css" href="css/dashboard.css"/>
</head>

<body>
<script type="text/javascript" src="js/d3.5.7.0.min.js"></script>
<script type="text/javascript" src="js/crossfilter.1.4.6.min.js"></script>
<script type="text/javascript" src="js/dc.3.0.9.min.js"></script>

<div class="container">

	<h2>Pilot Validation Dashboard <small>version 0.0.2</small></h2>
	<p>This page shows a <a href="example_reports/shops.json">validation report</a>, generated by R package validatereport from the validation demo in the regional conference.</p>
	<div id="divChartValue">
		<div>
			<strong>Events by value</strong>
			<a class="reset" style="visibility: hidden" href="#" onclick="chartValue.filter(null).redrawGroup();">reset</a>
		</div>
	</div>
	<div id="divChartSeverity">
		<div>
			<strong>Events by severity</strong>
			<a class="reset" style="visibility: hidden" href="#" onclick="chartSeverity.filter(null).redrawGroup();">reset</a>
		</div>
	</div>
	<div id="divChartActor">
		<div>
			<strong>Events by actor</strong>
			<a class="reset" style="visibility: hidden" href="#" onclick="chartActor.filter(null).redrawGroup()">reset</a>
		</div>
	</div>
	<div id="divChartAgent">
		<div>
			<strong>Events by agent</strong>
			<a class="reset" style="visibility: hidden" href="#" onclick="chartAgent.filter(null).redrawGroup()">reset</a>
		</div>
	</div>
	<br/>

	<div id="divChartRule">
		<div>
			<strong>Events by rule</strong>
			<a class="reset" style="visibility: hidden" href="#" onclick="chartRule.filter(null).redrawGroup()">reset</a>
		</div>
	</div><br/>

	<div class="row">
		<div id='divEventCount'>
		<span class='filter-count'></span>
		selected out of <span class='total-count'></span> records.
		</div>
	</div>

	<div id="divTableEvents">
	</div>

</div>

<script type="text/javascript">

dc.config.defaultColors(d3.schemeAccent);

var chartValue = dc.pieChart("#divChartValue"),
chartSeverity = dc.rowChart("#divChartSeverity"),
chartActor = dc.rowChart("#divChartActor"),
chartAgent = dc.rowChart("#divChartAgent"),
chartRule = dc.barChart('#divChartRule'),
eventCount = dc.dataCount('#divEventCount'),
tableEvents = dc.dataTable('#divTableEvents');

var myndx, valueDim, severityDim, agentDim, valueCount, severityCount,
actorDim, actorCount, all;

var colorScaleValues = d3.scaleOrdinal().domain(["0", "1", "NA"])
	.range(["#FC8D59", "#91CF60", "#FFFFBF"]);

d3.json("example_reports/shops.json").then(function(data) {
	
	// set crossfilter dimensions and counts:
	ndx = crossfilter(data),
	idDim = ndx.dimension(function (d) {
			return d.id;
		}),
	valueDim = ndx.dimension(function (d) {
			return d.value;
		}),
	severityDim = ndx.dimension(function (d) {
			return d.rule.severity;
		}),
	agentDim = ndx.dimension(function (d) {
			return d.event.agent;
		}),
	actorDim = ndx.dimension(function (d) {
			return d.event.actor;
		}),
	ruleDim = ndx.dimension(function (d) {
			if ("id" in d.rule)
				return d.rule.id;
			else
				return d.rule.expression.substr(0, 160);
		})
		valueCount = valueDim.group().reduceCount(),
	severityCount = severityDim.group().reduceCount(),
	agentCount = agentDim.group().reduceCount(),
	actorCount = actorDim.group().reduceCount(),
	ruleCount = ruleDim.group().reduceCount(),
	all = ndx.groupAll();

	render_plots();
});

function render_plots() {
	chartValue
	.width(200).height(170)
	.dimension(valueDim)
	.group(valueCount)
	.controlsUseVisibility(true)
	.innerRadius(0)
	.label(function (d) {
		//return d.key /*+" ("+ d.value+" )";*/
		return (d.key == 0 ? "fails" : (d.key == 1 ? "passes" : d.key)) /*+" ("+ d.value+" )";*/
	})
	.colors(function (d) {
		return colorScaleValues(d);
	});

	chartSeverity
	.width(200).height(200)
	.dimension(severityDim)
	.group(severityCount)
	.controlsUseVisibility(true)
	.elasticX(true)
	.ordinalColors(['#3182bd'])
	.label(function (d) {
		if (chartSeverity.hasFilter() && !chartSeverity.hasFilter(d.key)) {
			return d.key + ' (0%)';
		}
		var label = d.key;
		if (all.value()) {
			label += ' (' + Math.floor(d.value / all.value() * 100) + '%)';
		}
		return label;
	})
	.legend(dc.legend());

	chartActor
	.width(250).height(200)
	.dimension(actorDim)
	.group(actorCount)
	.controlsUseVisibility(true)
	.elasticX(true)
	.ordinalColors(['#3182bd'])
	.renderTitleLabel(false);

	chartAgent
	.width(250).height(200)
	.dimension(agentDim)
	.group(agentCount)
	.controlsUseVisibility(true)
	.ordinalColors(['#3182bd'])
	.elasticX(true);

	chartRule
	.width(800)
	.height(300)
	.x(d3.scaleBand())
	.xUnits(dc.units.ordinal)
	.brushOn(true)
	.xAxisLabel('Rules')
	.yAxisLabel('Count')
	.dimension(ruleDim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(ruleCount)
	.controlsUseVisibility(true)
	.elasticY(true)
	.ordinalColors(['#3182bd'])
	.xAxis().tickFormat("");

	eventCount
	.dimension(ndx)
	.group(all)
	.html({
		some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> events' +
		' | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'>Reset All</a>',
		all: 'All events selected. Click on the graphs to apply filters.'
	});

	tableEvents
	.dimension(idDim)
	.group(function (d) {
		return d.id;
	})
	.showGroups(false)
	.columns([
			'id', 'value', {
				label: 'time',
				format: function (d) {
					return (d.event.time);
				}
			}, {
				label: 'severity',
				format: function (d) {
					return (d.rule.severity == "error" ? "E" : (d.rule.severity == "information" ? "I" : "W"));
				}
			}, {
				label: 'language',
				format: function (d) {
					return (d.rule.language);
				}
			}, {
				label: 'change',
				format: function (d) {
					return (d.rule.change);
				}
			}, {
				label: 'actor',
				format: function (d) {
					return (d.event.actor);
				}
			}, {
				label: 'agent',
				format: function (d) {
					return (d.event.agent);
				}
			}, {
				label: 'trigger',
				format: function (d) {
					return (d.event.trigger);
				}
			}
		])
	.on("renderlet", function (chart) {
		chart.selectAll('tr.dc-table-row').style('background-color', function (d) {
			return colorScaleValues(d.value)
		})
	})

	dc.renderAll();
}

</script>

</body>
</html>
