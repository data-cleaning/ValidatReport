<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pilot Validation Dashboard</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
</head>

<body>
<link rel="stylesheet" type="text/css" href="https://dc-js.github.io/dc.js/css/dc.css"/>
<div class="container">
<script type="text/javascript" src="https://dc-js.github.io/dc.js/js/d3.js"></script>
<script type="text/javascript" src="https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
<script type="text/javascript" src="https://dc-js.github.io/dc.js/js/dc.js"></script>
<style>
	#tableEvents td {
		padding-left: 10px;
	}
	.dc-chart .pie-slice {
		fill: black;
	}
</style>

<h2>Pilot Validation Dashboard</h2>
<p>This page shows a <a href="example_reports/ex-18rulesvalidatfoundation_1000.json">validation report</a> of 1000 events, generated from the 18 rules of the ESSnet Validation Foundation POC (2015).</p>
<div id="divChartValue">
	<div>
		<strong>Events by value</strong>
		<a class="reset" style="visibility: hidden" href="#" onclick="chartValue.filter(null).redrawGroup();">reset</a>
	</div>
</div>
<div id="divChartSeverity">
	<div>
		<strong>Events by severity</strong>
		<a class="reset" style="visibility: hidden" href="#" onclick="chartSeverity.filter(null).redrawGroup();">reset</a>
	</div>
</div>
<div id="divChartActor">
	<div>
		<strong>Events by actor</strong>
		<a class="reset" style="visibility: hidden" href="#" onclick="chartActor.filter(null).redrawGroup()">reset</a>
	</div>
</div>
<div id="divChartAgent">
	<div>
		<strong>Events by agent</strong>
		<a class="reset" style="visibility: hidden" href="#" onclick="chartAgent.filter(null).redrawGroup()">reset</a>
	</div>
</div>
<br/>

<div id="divChartRule">
	<div>
		<strong>Events by rule</strong>
		<a class="reset" style="visibility: hidden" href="#" onclick="chartRule.filter(null).redrawGroup()">reset</a>
	</div>
</div><br/>

<div class="row">
	<div id='divEventCount'>
	 <span class='filter-count'></span>
	 selected out of <span class='total-count'></span> records.
	</div>
</div>

<div id="divTableEvents">
</div>

<script type="text/javascript">

var chartValue = dc.pieChart("#divChartValue"),
chartSeverity = dc.rowChart("#divChartSeverity"),
chartActor = dc.rowChart("#divChartActor"),
chartAgent = dc.rowChart("#divChartAgent"),
chartRule = dc.barChart('#divChartRule'),
eventCount = dc.dataCount('#divEventCount'),
tableEvents = dc.dataTable('#divTableEvents');

var myndx, valueDim, severityDim, agentDim, valueCount, severityCount,
actorDim, actorCount, all;

var colorScaleValues = d3.scale.ordinal().domain(["0", "1", "NA"])
	.range(["#FC8D59", "#91CF60", "#FFFFBF"]);

var data;
d3.json('example_reports/ex-18rulesvalidatfoundation_1000.json', function (error, json) {
	if (error)
		return console.warn(error);
	data = json;
	console.log(data)

	// set crossfilter dimensions and counts:
	ndx = crossfilter(data),
	idDim = ndx.dimension(function (d) {
			return d.id;
		}),
	valueDim = ndx.dimension(function (d) {
			return d.value;
		}),
	severityDim = ndx.dimension(function (d) {
			return d.rule.severity;
		}),
	agentDim = ndx.dimension(function (d) {
			return d.event.agent;
		}),
	actorDim = ndx.dimension(function (d) {
			return d.event.actor;
		}),
	ruleDim = ndx.dimension(function (d) {
			if ("id" in d.rule)
				return d.rule.id;
			else
				return d.rule.description.substr(0, 160);
		})
		valueCount = valueDim.group().reduceCount(),
	severityCount = severityDim.group().reduceCount(),
	agentCount = agentDim.group().reduceCount(),
	actorCount = actorDim.group().reduceCount(),
	ruleCount = ruleDim.group().reduceCount(),
	all = ndx.groupAll();

	render_plots();
});

function render_plots() {
	chartValue
	.width(200).height(170)
	.dimension(valueDim)
	.group(valueCount)
	.controlsUseVisibility(true)
	.innerRadius(0)
	.label(function (d) {
		//return d.key /*+" ("+ d.value+" )";*/
		return (d.key == 0 ? "fails" : (d.key == 1 ? "passes" : d.key)) /*+" ("+ d.value+" )";*/
	})
	.colors(function (d) {
		return colorScaleValues(d);
	});

	chartSeverity
	.width(200).height(200)
	.dimension(severityDim)
	.group(severityCount)
	.controlsUseVisibility(true)
	.elasticX(true)
	.label(function (d) {
		if (chartSeverity.hasFilter() && !chartSeverity.hasFilter(d.key)) {
			return d.key + ' (0%)';
		}
		var label = d.key;
		if (all.value()) {
			label += ' (' + Math.floor(d.value / all.value() * 100) + '%)';
		}
		return label;
	})
	.legend(dc.legend());

	chartActor
	.width(250).height(200)
	.dimension(actorDim)
	.group(actorCount)
	.controlsUseVisibility(true)
	.elasticX(true)
	.renderTitleLabel(false);

	chartAgent
	.width(250).height(200)
	.dimension(agentDim)
	.group(agentCount)
	.controlsUseVisibility(true)
	.elasticX(true);

	chartRule
	.width(800)
	.height(300)
	.x(d3.scale.ordinal())
	.xUnits(dc.units.ordinal)
	.brushOn(true)
	.xAxisLabel('Rules')
	.yAxisLabel('Count')
	.dimension(ruleDim)
	.barPadding(0.1)
	.outerPadding(0.05)
	.group(ruleCount)
	.controlsUseVisibility(true)
	.elasticY(true)
	.xAxis().tickFormat("");

	eventCount
	.dimension(ndx)
	.group(all)
	.html({
		some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> events' +
		' | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'>Reset All</a>',
		all: 'All events selected. Click on the graphs to apply filters.'
	});

	tableEvents
	.dimension(idDim)
	.group(function (d) {
		return d.id;
	})
	.showGroups(false)
	.columns([
			'id', 'value', {
				label: 'time',
				format: function (d) {
					return (d.event.time);
				}
			}, {
				label: 'severity',
				format: function (d) {
					return (d.rule.severity == "error" ? "E" : (d.rule.severity == "information" ? "I" : "W"));
				}
			}, {
				label: 'language',
				format: function (d) {
					return (d.rule.language);
				}
			}, {
				label: 'change',
				format: function (d) {
					return (d.rule.change);
				}
			}, {
				label: 'actor',
				format: function (d) {
					return (d.event.actor);
				}
			}, {
				label: 'agent',
				format: function (d) {
					return (d.event.agent);
				}
			}, {
				label: 'trigger',
				format: function (d) {
					return (d.event.trigger);
				}
			}
		])
	.on("renderlet", function (chart) {
		chart.selectAll('tr.dc-table-row').style('background-color', function (d) {
			return colorScaleValues(d.value)
		})
	})

	dc.renderAll();
}

</script>

</body>
</html>
